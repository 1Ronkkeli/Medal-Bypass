<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medal Bypass</title>
    <meta name="title" content="Medal Bypass" />
    <meta
      name="description"
      content="Download Medal Clips Easily Without Watermarks!"
    />
    <meta name="theme-color" content="#553EA8" />
    <meta
      name="keywords"
      content="Medal,Download,Free,Clips,Fortnite,Rocketleague,Valorant"
    />
    <meta name="robots" content="index, follow" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="language" content="English" />
    <meta name="author" content="Tyson3101" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link
      rel="manifest"
      crossorigin="use-credentials"
      href="site.webmanifest"
    />
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        color: rgb(0, 183, 134);
        background-color: rgb(29, 25, 25);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        text-align: center;
      }
      video {
        width: 40vw;
        height: auto;
        aspect-ratio: 16 / 9;
        margin-bottom: 1em;
      }
      a {
        display: block;
        padding: 0.5rem 0;
        color: rgb(179, 179, 238);
      }
      a:hover {
        color: rgb(120, 120, 205);
      }
      input {
        width: 40vw;
        height: 1.5rem;
      }
      button {
        margin-top: 1em;
        display: block;
        padding: 1rem;
        margin-bottom: 1em;
        cursor: pointer;
      }
      span {
        font-size: xx-large;
        font-weight: bolder;
      }
      #desc {
        font-size: 0.8em;
        font-weight: normal;
        display: block;
        margin-bottom: 1.4em;
      }
      h1 {
        margin-top: 0;
        margin-bottom: 0;
        font-size: 3rem;
      }
    </style>
  </head>
  <body>
    <h1 aria-label="Header">Medal Bypass</h1>
    <span id="desc" aria-label="Description"
      >Bypasses the requirement of Medal Premium in order to download clips
      without watermarks!</span
    >
    <input
      type="text"
      id="textbox"
      style="width: 70vw"
      aria-label="Input Medal Link Area"
      placeholder="Copy and Paste Medal Clip Here"
    />
    <button aria-label="Download Medal Clip">Download</button>
    <p
      style="display: none; font-size: x-large"
      id="loading"
      aria-label="Loading"
    >
      Loading.
    </p>
    <p
      style="
        position: fixed;
        bottom: 0;
        right: 0;
        text-align: left;
        font-size: 0.75em;
        font-weight: bold;
        margin-right: 1em;
      "
    >
      <a
        aria-label="Github Page"
        target="_blank"
        style="text-decoration: none; display: inline; color: inherit"
        href="https://github.com/Tyson3101"
      >
        By Tyson3101</a
      >
    </p>
    <div id="videos"></div>
    <script>
      let loadingInterval;
      let lastURLs = [];
      let cooldown = 0;
      const videosContainer = document.querySelector("#videos");
      const loading = document.querySelector("p");
      const button = document.querySelector("button");
      button.addEventListener("click", downloadVideo);
      const params = new URLSearchParams(document.location.search);
      if (params.get("url")?.length) {
        downloadVideo(params.get("url"));
      }

      async function downloadVideo(initialURL) {
        let url = document.querySelector("input").value;
        if (initialURL?.length) {
          url = initialURL;
        }
        // Checks if vaild url
        if (
          !url.length ||
          (!url.toLowerCase().includes("medal") &&
            !url.toLowerCase().includes("clips"))
        )
          return alert("Please input a vaild medal clip!");
        if (!url.toLowerCase().includes("?theater=true"))
          url += "?theater=true";
        if (!url.toLowerCase().startsWith("https://")) url = "https://" + url;
        // Check if downloading or is already downlowaed
        if (
          lastURLs.some(
            (u) =>
              url
                .toLowerCase()
                .split("/clips/")[1]
                .split("/")[0]
                .replace("?theater=true", "") ===
              u.url
                .toLowerCase()
                .split("/clips/")[1]
                .split("/")[0]
                .replace("?theater=true", "")
          )
        )
          return alert("Medal clip already downloading/downloaded!");
        if (cooldown > 0) return alert("Please wait " + cooldown + " seconds.");
        cooldown = 6;
        button.disabled = true;
        button.style.cursor = "not-allowed";
        button.innerText = "Wait " + cooldown + " seconds!";
        lastURLs.push({ url, active: true }); // History of clips
        const videoElement = document.createElement("video");
        const aElement = document.createElement("a");
        aElement.target = "_blank";
        aElement.download = "MedalDownload";
        aElement.innerText = "Download Here";
        const data = { url };
        startLoading();
        try {
          // Sends URL to server to download clip without watermark
          const fetchData = await fetch(
            "https://us-central1-medalbypass.cloudfunctions.net/video",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            }
          ).catch((e) => e);
          const video = await fetchData?.json(); // Returns download link
          lastURLs[lastURLs.findIndex((u) => u.url === url)].active = false; // Edits history to link toggle link to done
          stopLoading();
          // Checks if vaild
          if (!video?.valid) {
            // Remove url from history
            lastURLs.splice(
              lastURLs.findIndex((u) => u.url === url),
              1
            );
            return alert(
              "Please input a vaild Medal clip! (Make sure it's not private, etc..)\nOR Please give it a couple of seconds and retry!"
            );
          }
          // Adds download btn and video to screen
          aElement.href = video.src;
          videoElement.src = video.src;
          videoElement.controls = true;
          videosContainer.prepend(videoElement);
          videosContainer.prepend(aElement);
        } catch {
          // FOR ERRORS!
          lastURLs.splice(
            lastURLs.findIndex((u) => u.url === url),
            1
          );
          stopLoading();
          return alert(
            "Please input a vaild Medal clip! (Make sure it's not private, etc..)\nOR Please give it a couple of seconds and retry!"
          );
        }
      }
      function startLoading() {
        if (loadingInterval) clearInterval(loadingInterval);
        loading.style.display = "block";
        let numOfDots = 1;
        loadingInterval = setInterval(() => {
          numOfDots += 1;
          if (numOfDots >= 4) numOfDots = 1;
          loading.innerText = "Loading" + ".".repeat(numOfDots);
        }, 500);
      }
      function stopLoading() {
        if (lastURLs.some((u) => u.active)) return;
        if (loadingInterval) clearInterval(loadingInterval);
        loading.style.display = "none";
      }

      // Cooldown
      setInterval(() => {
        if (cooldown > 0) {
          button.disabled = true;
          button.style.cursor = "not-allowed";
          button.innerText = "Wait " + cooldown + " seconds!";
          cooldown--;
        } else {
          button.disabled = false;
          button.style.cursor = "pointer";
          if (button.innerText !== "Download")
            button.innerText = "Download Another Clip";
        }
      }, 1000);

      // What you looking in here for ?!
    </script>
  </body>
</html>
